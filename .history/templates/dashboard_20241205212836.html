<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retail KPI Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css">
    <link rel="stylesheet" src="../style/css/style.css"/>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center mb-4">Retail KPI Dashboard</h1>
        <p class="text-center">Welcome, {{ username }}! <a href="/logout">Logout</a></p>
        <div class="mb-4">
            <label for="hshd_num" class="form-label">Enter Household Number:</label>
            <input type="text" id="hshd_num" class="form-control" placeholder="e.g., 159">
            <button id="fetchDataBtn" class="btn btn-primary mt-3">Fetch Data</button>
        </div>
        <div class="row text-center mb-4">
            <div class="col-md-4">
                <h3>Total Sales</h3>
                <p id="totalSales">$0</p>
            </div>
            <div class="col-md-4">
                <h3>Average Price</h3>
                <p id="averagePrice">$0</p>
            </div>
            <div class="col-md-4">
                <h3>Total Units Sold</h3>
                <p id="totalUnitsSold">0</p>
            </div>
        </div>
        <div class="row text-center mb-4">
            <h3>Demographics</h3>
            <p id="householdDetails">No data available.</p>
        </div>
        <div class="row">
            <div class="col-md-6">
                <h3>Sales by Division</h3>
                <canvas id="divisionChart"></canvas>
            </div>
            <div class="col-md-6">
                <h3>Top 5 Selling Commodities</h3>
                <canvas id="commoditiesChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        document.getElementById("fetchDataBtn").addEventListener("click", function () {
            const hshdNum = document.getElementById("hshd_num").value;

            if (!hshdNum) {
                alert("Please enter a Household Number.");
                return;
            }

            fetch("/fetch_data", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: `hshd_num=${hshdNum}`
            })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                    } else {
                        document.getElementById("totalSales").textContent = data.total_sales;
                        document.getElementById("averagePrice").textContent = data.average_price;
                        document.getElementById("totalUnitsSold").textContent = data.total_units_sold;

                        const demographics = data.demographics;
                        document.getElementById("householdDetails").textContent = `
                            Age Range: ${demographics.AGE_RANGE}, 
                            Marital Status: ${demographics.MARITAL}, 
                            Income Range: ${demographics.INCOME_RANGE}, 
                            Homeowner: ${demographics.HOMEOWNER}
                        `;

                        const divisionLabels = data.sales_by_division.map(item => item.STORE_R);
                        const divisionData = data.sales_by_division.map(item => item.SPEND);

                        const commoditiesLabels = data.top_commodities.map(item => item.COMMODITY);
                        const commoditiesData = data.top_commodities.map(item => item.SPEND);

                        new Chart(document.getElementById("divisionChart"), {
                            type: "bar",
                            data: {
                                labels: divisionLabels,
                                datasets: [{
                                    label: "Sales",
                                    data: divisionData,
                                    backgroundColor: "rgba(75, 192, 192, 0.6)"
                                }]
                            }
                        });

                        new Chart(document.getElementById("commoditiesChart"), {
                            type: "bar",
                            data: {
                                labels: commoditiesLabels,
                                datasets: [{
                                    label: "Sales",
                                    data: commoditiesData,
                                    backgroundColor: "rgba(153, 102, 255, 0.6)"
                                }]
                            }
                        });
                    }
                })
                .catch(error => console.error("Error:", error));
        });
    </script>
</body>
</html>